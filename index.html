<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotimusic</title>
    <meta name="description" content="Votre plateforme musicale pr√©f√©r√©e">
    <meta name="theme-color" content="#1e40af">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3BvdGltdXNpYyIsInNob3J0X25hbWUiOiJTcG90aW11c2ljIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwYjE0MjYiLCJ0aGVtZV9jb2xvciI6IiMxZTQwYWYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhabGNuTnBiMjQ5SWpFeUxqQWlJSGh0Ykc1eld6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lQZ284WTJseVkyeGxJR04zUFNJNU1pSWdabWxzYkQwaUl6RmxOREJoWmlJZ2NqMGlNall1TkNJdlBqeDBaWGgwSUhnOUlqWTBJaUI1UFNJMk9DSWdabWxzYkQwaUkzZG1abVptWmlJZ1ptOXVkRjl6YVhwbFBTSTFOQ0lnWm05dWRGOW1ZVzFwYkhrOUlsaHNZVzVqWlhnaUlIUmxlSFJmWVc1amFHOXlQU0p0YVdSa2JHVWlQbE04TDNSbGVIUStQQzl6ZG1jK0lnPT0iLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0b1426 0%, #1e3a8a 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(30, 64, 175, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #60a5fa;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(10px);
        }

        .search-box::placeholder {
            color: rgba(255,255,255,0.7);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            padding: 0.5rem;
            gap: 0.5rem;
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        /* Search Results */
        .search-results {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .search-results.active {
            display: grid;
        }

        .track-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .track-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .track-info h3 {
            margin-bottom: 0.5rem;
            color: #60a5fa;
            font-size: 1rem;
        }

        .track-info p {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .track-duration {
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
        }

        /* Home Page */
        .home-content {
            display: block;
        }

        .home-content.hidden {
            display: none;
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h2 {
            margin-bottom: 1rem;
            color: #60a5fa;
            font-size: 1.5rem;
        }

        .welcome-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .welcome-card h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #60a5fa, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Player */
        .player {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            padding: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .player.hidden {
            display: none;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.1);
        }

        .play-btn {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            width: 0%;
            transition: width 0.1s;
        }

        /* Playlists */
        .playlist-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .playlist-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(10px);
        }

        /* Library */
        .library-content, .playlists-content {
            display: none;
        }

        .library-content.active, .playlists-content.active {
            display: block;
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .library-item {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .library-item:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.2);
        }

        /* YouTube Player Container */
        .youtube-player-container {
            position: fixed;
            top: -500px;
            left: -500px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.5rem;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .search-results {
                grid-template-columns: 1fr;
            }
            
            .welcome-card h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(0,0,0,0.9);
                z-index: 100;
            }
            
            .content-area {
                padding-bottom: 80px;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255,255,255,0.7);
        }

        .error {
            color: #ef4444;
            text-align: center;
            padding: 1rem;
        }

        .api-notice {
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid rgba(234, 179, 8, 0.5);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            color: #fbbf24;
        }

        .offline-section {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .upload-area.dragover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.2);
        }

        .offline-track {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .offline-controls {
            display: flex;
            gap: 0.5rem;
        }

        .offline-btn {
            background: rgba(34, 197, 94, 0.8);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .offline-btn:hover {
            background: rgba(34, 197, 94, 1);
            transform: scale(1.05);
        }

        .offline-btn.delete {
            background: rgba(239, 68, 68, 0.8);
        }

        .offline-btn.delete:hover {
            background: rgba(239, 68, 68, 1);
        }

        .offline-indicator {
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .storage-info {
            background: rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .progress-upload {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-upload-fill {
            height: 100%;
            background: linear-gradient(45deg, #22c55e, #16a34a);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="64" cy="64" r="50" fill="#1e40af"/>
                    <text x="64" y="74" fill="white" font-size="40" font-family="Arial" text-anchor="middle">‚ô™</text>
                </svg>
                Spotimusic
            </div>
            <div class="search-container">
                <input type="text" class="search-box" placeholder="Rechercher de la musique..." id="searchInput">
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="home">üè† Accueil</button>
                <button class="nav-tab" data-tab="search">üîç Recherche</button>
                <button class="nav-tab" data-tab="offline">üì± Hors ligne</button>
                <button class="nav-tab" data-tab="library">üìö Biblioth√®que</button>
                <button class="nav-tab" data-tab="playlists">üìã Playlists</button>
            </div>

            <div class="content-area">
                <!-- Home Content -->
                <div class="home-content" id="homeContent">
                    <div class="welcome-card">
                        <h1>üéµ Bienvenue sur Spotimusic</h1>
                        <p>D√©couvrez et √©coutez vos musiques pr√©f√©r√©es</p>
                    </div>
                    
                    <div class="api-notice">
                        <h3>üîß Configuration requise</h3>
                        <p>Pour utiliser Spotimusic, vous devez configurer une cl√© API YouTube :</p>
                        <ol>
                            <li>Allez sur <a href="https://console.developers.google.com" target="_blank">Google Cloud Console</a></li>
                            <li>Cr√©ez un projet et activez l'API YouTube Data v3</li>
                            <li>G√©n√©rez une cl√© API</li>
                            <li>Entrez-la ci-dessous :</li>
                        </ol>
                        <input type="text" id="apiKeyInput" placeholder="Entrez votre cl√© API YouTube..." style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 5px; border: none;">
                        <button onclick="saveApiKey()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #1e40af; color: white; border: none; border-radius: 5px; cursor: pointer;">Sauvegarder</button>
                    </div>

                    <div class="section">
                        <h2>üéß √âcoute r√©cente</h2>
                        <div id="recentTracks"></div>
                    </div>

                    <div class="section">
                        <h2>üî• Tendances</h2>
                        <div class="library-grid" id="trendingMusic"></div>
                    </div>
                </div>

                <!-- Search Content -->
                <div class="search-results" id="searchResults"></div>

                <!-- Offline Content -->
                <div class="offline-content" id="offlineContent" style="display: none;">
                    <h2>üì± Musique Hors Ligne</h2>
                    
                    <div class="offline-section">
                        <h3>üéµ Ajoutez votre propre musique</h3>
                        <p>Importez vos fichiers MP3 pour les √©couter hors ligne (musique libre de droits ou que vous poss√©dez)</p>
                        
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon" style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                            <p>Glissez-d√©posez vos fichiers MP3 ici ou cliquez pour s√©lectionner</p>
                            <input type="file" id="fileInput" accept="audio/mp3,audio/mpeg,audio/wav,audio/ogg" multiple style="display: none;">
                        </div>
                        
                        <div class="progress-upload" id="uploadProgress" style="display: none;">
                            <div class="progress-upload-fill" id="uploadProgressFill"></div>
                        </div>
                    </div>

                    <div class="storage-info">
                        <h4>üíæ Stockage utilis√©</h4>
                        <p id="storageInfo">Calcul en cours...</p>
                        <button onclick="clearOfflineStorage()" class="offline-btn delete" style="margin-top: 0.5rem;">Vider le stockage</button>
                    </div>

                    <div class="section">
                        <h3>üéß Musiques disponibles hors ligne</h3>
                        <div id="offlineTracksContainer">
                            <p>Aucune musique hors ligne disponible</p>
                        </div>
                    </div>
                </div>

                <!-- Library Content -->
                <div class="library-content" id="libraryContent">
                    <h2>üìö Ma Biblioth√®que</h2>
                    <div class="library-grid" id="libraryGrid"></div>
                </div>

                <!-- Playlists Content -->
                <div class="playlists-content" id="playlistsContent">
                    <h2>üìã Mes Playlists</h2>
                    <button onclick="createPlaylist()" style="background: linear-gradient(45deg, #1e40af, #3b82f6); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 25px; margin-bottom: 1rem; cursor: pointer;">Cr√©er une playlist</button>
                    <div id="playlistsList"></div>
                </div>
            </div>
        </div>

        <!-- Player -->
        <div class="player hidden" id="player">
            <div class="player-info">
                <div>
                    <h4 id="currentTrack">Aucune musique</h4>
                    <p id="currentArtist">S√©lectionnez une musique</p>
                </div>
            </div>
            <div class="player-controls">
                <button class="control-btn" onclick="previousTrack()">‚èÆÔ∏è</button>
                <button class="control-btn play-btn" onclick="togglePlay()" id="playButton">‚ñ∂Ô∏è</button>
                <button class="control-btn" onclick="nextTrack()">‚è≠Ô∏è</button>
            </div>
            <div class="progress-bar" onclick="seekTo(event)">
                <div class="progress" id="progressBar"></div>
            </div>
        </div>

        <!-- Hidden YouTube Player -->
        <div class="youtube-player-container">
            <div id="youtube-player"></div>
        </div>
    </div>

    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // Global variables
        let player;
        let currentTrack = null;
        let isPlaying = false;
        let searchResults = [];
        let playlists = JSON.parse(localStorage.getItem('spotimusic-playlists') || '[]');
        let library = JSON.parse(localStorage.getItem('spotimusic-library') || '[]');
        let recentTracks = JSON.parse(localStorage.getItem('spotimusic-recent') || '[]');
        let apiKey = localStorage.getItem('youtube-api-key') || '';
        let offlineTracks = JSON.parse(localStorage.getItem('spotimusic-offline') || '[]');
        let audioPlayer = new Audio();
        let isOfflineMode = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadRecentTracks();
            loadLibrary();
            loadPlaylists();
            loadTrendingMusic();
            loadOfflineTracks();
            updateStorageInfo();
            initializeOfflineFeatures();
        });

        // YouTube API Ready
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '360',
                width: '640',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            console.log('YouTube player ready');
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                document.getElementById('playButton').textContent = '‚è∏Ô∏è';
                startProgressUpdate();
            } else if (event.data == YT.PlayerState.PAUSED) {
                isPlaying = false;
                document.getElementById('playButton').textContent = '‚ñ∂Ô∏è';
            } else if (event.data == YT.PlayerState.ENDED) {
                nextTrack();
            }
        }

        // Initialize app
        function initializeApp() {
            // API key input
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
            }

            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', debounce(searchMusic, 500));

            // Audio player events
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextTrack);
            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                document.getElementById('playButton').textContent = '‚è∏Ô∏è';
            });
            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                document.getElementById('playButton').textContent = '‚ñ∂Ô∏è';
            });
        }

        // Save API key
        function saveApiKey() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('youtube-api-key', apiKey);
                alert('Cl√© API sauvegard√©e ! Vous pouvez maintenant rechercher de la musique.');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Show/hide content
            document.getElementById('homeContent').classList.toggle('hidden', tabName !== 'home');
            document.getElementById('searchResults').classList.toggle('active', tabName === 'search');
            document.getElementById('offlineContent').style.display = tabName === 'offline' ? 'block' : 'none';
            document.getElementById('libraryContent').classList.toggle('active', tabName === 'library');
            document.getElementById('playlistsContent').classList.toggle('active', tabName === 'playlists');
        }

        // Search music
        async function searchMusic() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query || !apiKey) return;

            const searchContainer = document.getElementById('searchResults');
            searchContainer.innerHTML = '<div class="loading">üîç Recherche en cours...</div>';

            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q=${encodeURIComponent(query + ' music')}&type=video&key=${apiKey}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                searchResults = data.items || [];
                displaySearchResults();
                switchTab('search');
            } catch (error) {
                searchContainer.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Display search results
        function displaySearchResults() {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (searchResults.length === 0) {
                container.innerHTML = '<div class="error">Aucun r√©sultat trouv√©</div>';
                return;
            }

            searchResults.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'track-card';
                card.innerHTML = `
                    <div class="track-info">
                        <h3>${item.snippet.title}</h3>
                        <p>${item.snippet.channelTitle}</p>
                        <div class="track-duration">üì∫ YouTube</div>
                    </div>
                `;
                card.addEventListener('click', () => playTrack(item));
                container.appendChild(card);
            });
        }

        // Play track
        function playTrack(track) {
            currentTrack = track;
            
            // Update UI
            document.getElementById('currentTrack').textContent = track.snippet ? track.snippet.title : track.name;
            document.getElementById('currentArtist').textContent = track.snippet ? track.snippet.channelTitle : track.artist;
            document.getElementById('player').classList.remove('hidden');

            // Add to recent tracks
            addToRecent(track);

            // Check if it's an offline track
            if (track.isOffline) {
                isOfflineMode = true;
                audioPlayer.src = track.audioUrl;
                audioPlayer.play();
            } else {
                isOfflineMode = false;
                if (!player) {
                    alert('Le lecteur n\'est pas encore pr√™t. Veuillez patienter...');
                    return;
                }
                // Play YouTube video
                player.loadVideoById(track.id.videoId || track.id);
                player.playVideo();
            }
        }

        // Player controls
        function togglePlay() {
            if (!currentTrack) return;

            if (isOfflineMode) {
                if (isPlaying) {
                    audioPlayer.pause();
                } else {
                    audioPlayer.play();
                }
            } else {
                if (!player) return;
                if (isPlaying) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                }
            }
        }

        function nextTrack() {
            // Simple implementation - could be enhanced with queue
            console.log('Next track');
        }

        function previousTrack() {
            // Simple implementation - could be enhanced with queue
            console.log('Previous track');
        }

        function seekTo(event) {
            if (!currentTrack) return;

            const progressBar = event.currentTarget;
            const clickX = event.offsetX;
            const width = progressBar.offsetWidth;
            const percentage = clickX / width;

            if (isOfflineMode) {
                const duration = audioPlayer.duration;
                audioPlayer.currentTime = duration * percentage;
            } else {
                if (!player) return;
                const duration = player.getDuration();
                player.seekTo(duration * percentage);
            }
        }

        // Progress update
        function updateProgress() {
            if (!currentTrack) return;

            let currentTime, duration, percentage;

            if (isOfflineMode) {
                currentTime = audioPlayer.currentTime;
                duration = audioPlayer.duration;
            } else {
                if (!player) return;
                currentTime = player.getCurrentTime();
                duration = player.getDuration();
            }

            if (duration > 0) {
                percentage = (currentTime / duration) * 100;
                document.getElementById('progressBar').style.width = percentage + '%';
            }
        }

        function startProgressUpdate() {
            setInterval(updateProgress, 1000);
        }

        // Recent tracks
        function addToRecent(track) {
            recentTracks = recentTracks.filter(t => t.id !== track.id);
            recentTracks.unshift(track);
            recentTracks = recentTracks.slice(0, 10);
            localStorage.setItem('spotimusic-recent', JSON.stringify(recentTracks));
            loadRecentTracks();
        }

        function loadRecentTracks() {
            const container = document.getElementById('recentTracks');
            if (recentTracks.length === 0) {
                container.innerHTML = '<p>Aucune √©coute r√©cente</p>';
                return;
            }

            container.innerHTML = recentTracks.slice(0, 5).map(track => `
                <div class="playlist-item" onclick="playTrack(${JSON.stringify(track).replace(/"/g, '&quot;')})">
                    <strong>${track.snippet.title}</strong><br>
                    <small>${track.snippet.channelTitle}</small>
                </div>
            `).join('');
        }

        // Library management
        function addToLibrary(track) {
            if (!library.find(t => t.id === track.id)) {
                library.push(track);
                localStorage.setItem('spotimusic-library', JSON.stringify(library));
                loadLibrary();
            }
        }

        function loadLibrary() {
            const container = document.getElementById('libraryGrid');
            if (library.length === 0) {
                container.innerHTML = '<p>Votre biblioth√®que est vide</p>';
                return;
            }

            container.innerHTML = library.map(track => `
                <div class="library-item" onclick="playTrack(${JSON.stringify(track).replace(/"/g, '&quot;')})">
                    <h4>${track.snippet.title}</h4>
                    <p>${track.snippet.channelTitle}</p>
                </div>
            `).join('');
        }

        // Playlist management
        function createPlaylist() {
            const name = prompt('Nom de la playlist:');
            if (name) {
                const playlist = {
                    id: Date.now(),
                    name: name,
                    tracks: []
                };
                playlists.push(playlist);
                localStorage.setItem('spotimusic-playlists', JSON.stringify(playlists));
                loadPlaylists();
            }
        }

        function loadPlaylists() {
            const container = document.getElementById('playlistsList');
            if (playlists.length === 0) {
                container.innerHTML = '<p>Aucune playlist cr√©√©e</p>';
                return;
            }

            container.innerHTML = playlists.map(playlist => `
                <div class="playlist-item">
                    <strong>${playlist.name}</strong><br>
                    <small>${playlist.tracks.length} musiques</small>
                </div>
            `).join('');
        }

        // Trending music (example data)
        function loadTrendingMusic() {
            const trending = [
                'Top hits 2024',
                'Electronic music',
                'Jazz classics',
                'Rock legends',
                'Pop fran√ßais',
                'Hip-hop vibes'
            ];

            const container = document.getElementById('trendingMusic');
            container.innerHTML = trending.map(genre => `
                <div class="library-item" onclick="searchGenre('${genre}')">
                    <h4>üéµ ${genre}</h4>
                    <p>D√©couvrir</p>
                </div>
            `).join('');
        }

            searchGenre();
        }

        // Offline functionality
        function initializeOfflineFeatures() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // Click to upload
            uploadArea.addEventListener('click', () => fileInput.click());

            // File input change
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => 
                file.type.startsWith('audio/') || file.name.endsWith('.mp3')
            );

            if (validFiles.length === 0) {
                alert('Veuillez s√©lectionner des fichiers audio valides (MP3, WAV, OGG)');
                return;
            }

            const progressContainer = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('uploadProgressFill');
            
            progressContainer.style.display = 'block';

            for (let i = 0; i < validFiles.length; i++) {
                const file = validFiles[i];
                const progress = ((i + 1) / validFiles.length) * 100;
                progressFill.style.width = progress + '%';

                await processAudioFile(file);
            }

            progressContainer.style.display = 'none';
            loadOfflineTracks();
            updateStorageInfo();
        }

        async function processAudioFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const audioData = e.target.result;
                    
                    // Extract basic metadata
                    const track = {
                        id: 'offline_' + Date.now() + '_' + Math.random(),
                        name: file.name.replace(/\.[^/.]+$/, ""),
                        artist: 'Artiste inconnu',
                        duration: 0,
                        audioUrl: audioData,
                        isOffline: true,
                        size: file.size,
                        addedAt: new Date().toISOString()
                    };

                    // Add to offline tracks
                    offlineTracks.push(track);
                    localStorage.setItem('spotimusic-offline', JSON.stringify(offlineTracks));
                    
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        function loadOfflineTracks() {
            const container = document.getElementById('offlineTracksContainer');
            
            if (offlineTracks.length === 0) {
                container.innerHTML = '<p>Aucune musique hors ligne disponible</p>';
                return;
            }

            container.innerHTML = offlineTracks.map(track => `
                <div class="offline-track">
                    <div>
                        <strong>${track.name}</strong><br>
                        <small>${track.artist} ‚Ä¢ ${formatFileSize(track.size)}</small>
                        <span class="offline-indicator">HORS LIGNE</span>
                    </div>
                    <div class="offline-controls">
                        <button class="offline-btn" onclick="playOfflineTrack('${track.id}')">‚ñ∂Ô∏è Lire</button>
                        <button class="offline-btn delete" onclick="deleteOfflineTrack('${track.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function playOfflineTrack(trackId) {
            const track = offlineTracks.find(t => t.id === trackId);
            if (track) {
                playTrack(track);
            }
        }

        function deleteOfflineTrack(trackId) {
            if (confirm('Supprimer cette musique hors ligne ?')) {
                offlineTracks = offlineTracks.filter(t => t.id !== trackId);
                localStorage.setItem('spotimusic-offline', JSON.stringify(offlineTracks));
                loadOfflineTracks();
                updateStorageInfo();
            }
        }

        function clearOfflineStorage() {
            if (confirm('Supprimer toutes les musiques hors ligne ? Cette action est irr√©versible.')) {
                offlineTracks = [];
                localStorage.setItem('spotimusic-offline', JSON.stringify(offlineTracks));
                loadOfflineTracks();
                updateStorageInfo();
            }
        }

        function updateStorageInfo() {
            const totalSize = offlineTracks.reduce((sum, track) => sum + track.size, 0);
            const trackCount = offlineTracks.length;
            
            document.getElementById('storageInfo').innerHTML = `
                <strong>${trackCount}</strong> musiques ‚Ä¢ <strong>${formatFileSize(totalSize)}</strong> utilis√©s
            `;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function searchGenre(genre) {
            document.getElementById('searchInput').value = genre;
            searchMusic();
        }

        // Utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,console.log("SW loaded")');
        }

        // Start progress updates
        startProgressUpdate();
    </script>
</body>
</html>
